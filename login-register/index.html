<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤å…ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/base.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loading-container {
            text-align: center;
            color: white;
            padding: 40px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .loading-title {
            font-size: 2.5em;
            margin-bottom: 20px;
            font-weight: 300;
        }
        
        .loading-subtitle {
            font-size: 1.2em;
            margin-bottom: 30px;
            opacity: 0.8;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-status {
            font-size: 1em;
            opacity: 0.7;
            margin-top: 15px;
        }
        
        .error-message {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        
        .manual-links {
            margin-top: 30px;
        }
        
        .manual-links a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            padding: 10px 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            transition: all 0.3s ease;
            display: inline-block;
        }
        
        .manual-links a:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="loading-container">
        <h1 class="loading-title">ğŸ½ï¸ é¤å…ç®¡ç†ç³»ç»Ÿ</h1>
        <p class="loading-subtitle">æ­£åœ¨æ£€æŸ¥ç™»å½•çŠ¶æ€...</p>
        
        <div class="loading-spinner"></div>
        
        <div class="loading-status" id="status">åˆå§‹åŒ–ä¸­...</div>
        
        <div id="error-container"></div>
        
        <div class="manual-links" id="manual-links" style="display: none;">
            <a href="login.html">ç™»å½•é¡µé¢</a>
            <a href="admin.html">ç®¡ç†åå°</a>
        </div>
    </div>

    <script src="js/cookie-utils.js"></script>
    <script>
        // çŠ¶æ€æ›´æ–°å‡½æ•°
        function updateStatus(message, isError = false) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            
            if (isError) {
                statusElement.style.color = '#ff6b6b';
            }
            
            console.log(`[çŠ¶æ€] ${message}`);
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `
                <div class="error-message">
                    <strong>é”™è¯¯:</strong> ${message}
                    <br><br>
                    è¯·æ‰‹åŠ¨é€‰æ‹©é¡µé¢æˆ–åˆ·æ–°é‡è¯•
                </div>
            `;
            
            // æ˜¾ç¤ºæ‰‹åŠ¨é“¾æ¥
            document.getElementById('manual-links').style.display = 'block';
        }

        // è‡ªåŠ¨è·³è½¬å‡½æ•°
        function redirectTo(url, reason) {
            updateStatus(`${reason}ï¼Œå³å°†è·³è½¬...`);
            
            setTimeout(() => {
                console.log(`[è·³è½¬] è·³è½¬åˆ°: ${url}`);
                window.location.href = url;
            }, 1500);
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶è·³è½¬
        async function checkAuthAndRedirect() {
            try {
                updateStatus('æ­£åœ¨æ£€æŸ¥Cookieç™»å½•çŠ¶æ€...');
                console.log('å¼€å§‹æ£€æŸ¥ç™»å½•çŠ¶æ€...');

                // ç­‰å¾…ä¸€ä¸‹ç¡®ä¿Cookieå·¥å…·åŠ è½½å®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 500));

                // æ£€æŸ¥Cookieå·¥å…·æ˜¯å¦å¯ç”¨
                if (typeof AuthCookies === 'undefined') {
                    throw new Error('Cookieå·¥å…·æœªåŠ è½½');
                }

                updateStatus('æ£€æŸ¥Cookieä¸­çš„ç™»å½•ä¿¡æ¯...');
                console.log('Cookieå·¥å…·å·²åŠ è½½ï¼Œå¼€å§‹æ£€æŸ¥...');

                // æ˜¾ç¤ºåŸå§‹Cookieä¿¡æ¯
                console.log('åŸå§‹Cookieå­—ç¬¦ä¸²:', document.cookie);

                // æ£€æŸ¥Cookieä¸­çš„ç™»å½•çŠ¶æ€
                const isLoggedInCookie = AuthCookies.isLoggedIn();
                const isExpiredCookie = AuthCookies.isLoginExpired();
                const loginInfo = AuthCookies.getLoginInfo();

                console.log('Cookieç™»å½•æ£€æŸ¥è¯¦ç»†ç»“æœ:', {
                    isLoggedIn: isLoggedInCookie,
                    isExpired: isExpiredCookie,
                    loginInfo: loginInfo
                });

                if (isLoggedInCookie && !isExpiredCookie) {
                    // Cookieä¸­æœ‰æœ‰æ•ˆçš„ç™»å½•ä¿¡æ¯
                    console.log('âœ… å‘ç°æœ‰æ•ˆçš„Cookieç™»å½•ä¿¡æ¯:', loginInfo);

                    updateStatus(`æ¬¢è¿å›æ¥ï¼Œ${loginInfo.username || 'ç”¨æˆ·'}ï¼`);
                    redirectTo('admin.html', 'å·²ç™»å½•');
                    return;
                } else {
                    console.log('âŒ Cookieç™»å½•æ£€æŸ¥å¤±è´¥:', {
                        isLoggedIn: isLoggedInCookie,
                        isExpired: isExpiredCookie,
                        reason: !isLoggedInCookie ? 'Cookieä¸­æ— ç™»å½•ä¿¡æ¯' : 'ç™»å½•å·²è¿‡æœŸ'
                    });
                }
                
                updateStatus('æ£€æŸ¥localStorageç™»å½•çŠ¶æ€...');
                console.log('å¼€å§‹æ£€æŸ¥localStorageçŠ¶æ€...');

                // æ£€æŸ¥localStorageä¸­çš„ç™»å½•çŠ¶æ€ï¼ˆå‘åå…¼å®¹ï¼‰
                const token = localStorage.getItem('token');
                const isLoggedInLocal = sessionStorage.getItem('isLoggedIn');
                const username = sessionStorage.getItem('username');

                console.log('localStorageç™»å½•æ£€æŸ¥è¯¦ç»†ç»“æœ:', {
                    hasToken: !!token,
                    token: token ? token.substring(0, 20) + '...' : null,
                    isLoggedIn: isLoggedInLocal,
                    username: username
                });

                if (token && isLoggedInLocal === 'true') {
                    // localStorageä¸­æœ‰ç™»å½•ä¿¡æ¯ï¼Œå°è¯•è¿ç§»åˆ°Cookie
                    console.log('âœ… å‘ç°localStorageä¸­çš„æœ‰æ•ˆç™»å½•ä¿¡æ¯');
                    updateStatus('å‘ç°æœ¬åœ°ç™»å½•ä¿¡æ¯ï¼Œæ­£åœ¨è¿ç§»åˆ°Cookie...');

                    try {
                        const migrated = AuthCookies.migrateFromLocalStorage();
                        if (migrated) {
                            console.log('âœ… æˆåŠŸè¿ç§»localStorageæ•°æ®åˆ°Cookie');
                            updateStatus('ç™»å½•ä¿¡æ¯å·²æ›´æ–°');
                            redirectTo('admin.html', 'ç™»å½•çŠ¶æ€å·²æ¢å¤');
                            return;
                        } else {
                            console.log('âš ï¸ è¿ç§»æœªæ‰§è¡Œï¼Œä½†localStorageçŠ¶æ€æœ‰æ•ˆ');
                            updateStatus('ä½¿ç”¨æœ¬åœ°ç™»å½•ä¿¡æ¯');
                            redirectTo('admin.html', 'å·²ç™»å½•');
                            return;
                        }
                    } catch (migrateError) {
                        console.warn('âš ï¸ è¿ç§»å¤±è´¥ï¼Œä½†ä»ç„¶è·³è½¬åˆ°åå°:', migrateError);
                        updateStatus('ä½¿ç”¨æœ¬åœ°ç™»å½•ä¿¡æ¯');
                        redirectTo('admin.html', 'å·²ç™»å½•');
                        return;
                    }
                } else {
                    console.log('âŒ localStorageç™»å½•æ£€æŸ¥å¤±è´¥:', {
                        hasToken: !!token,
                        isLoggedIn: isLoggedInLocal,
                        reason: !token ? 'æ— token' : 'isLoggedInä¸ä¸ºtrue'
                    });
                }
                
                // æ²¡æœ‰æœ‰æ•ˆçš„ç™»å½•ä¿¡æ¯
                updateStatus('æœªæ£€æµ‹åˆ°ç™»å½•ä¿¡æ¯');
                redirectTo('login.html', 'éœ€è¦ç™»å½•');
                
            } catch (error) {
                console.error('ç™»å½•çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
                updateStatus('æ£€æŸ¥ç™»å½•çŠ¶æ€æ—¶å‡ºé”™', true);
                showError(error.message);
            }
        }

        // æ£€æŸ¥URLå‚æ•°
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const redirect = urlParams.get('redirect');
            
            if (redirect) {
                console.log('æ£€æµ‹åˆ°é‡å®šå‘å‚æ•°:', redirect);
                
                if (redirect === 'login') {
                    updateStatus('å¼ºåˆ¶è·³è½¬åˆ°ç™»å½•é¡µé¢');
                    redirectTo('login.html', 'æ‰‹åŠ¨è·³è½¬');
                    return true;
                } else if (redirect === 'admin') {
                    updateStatus('å¼ºåˆ¶è·³è½¬åˆ°ç®¡ç†åå°');
                    redirectTo('admin.html', 'æ‰‹åŠ¨è·³è½¬');
                    return true;
                }
            }
            
            return false;
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¦–é¡µåŠ è½½å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥ç™»å½•çŠ¶æ€');
            
            // æ˜¾ç¤ºæµè§ˆå™¨ä¿¡æ¯
            console.log('æµè§ˆå™¨ä¿¡æ¯:', {
                userAgent: navigator.userAgent,
                cookieEnabled: navigator.cookieEnabled,
                url: window.location.href
            });
            
            // æ£€æŸ¥URLå‚æ•°
            if (checkUrlParams()) {
                return;
            }
            
            // å¼€å§‹ç™»å½•çŠ¶æ€æ£€æŸ¥
            checkAuthAndRedirect();
        });

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('é¡µé¢é‡æ–°å¯è§ï¼Œé‡æ–°æ£€æŸ¥ç™»å½•çŠ¶æ€');
                // é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œé‡æ–°æ£€æŸ¥ç™»å½•çŠ¶æ€
                setTimeout(checkAuthAndRedirect, 1000);
            }
        });

        // é”™è¯¯å¤„ç†
        window.addEventListener('error', function(event) {
            console.error('é¡µé¢é”™è¯¯:', event.error);
            updateStatus('é¡µé¢åŠ è½½å‡ºé”™', true);
            showError('é¡µé¢åŠ è½½æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·åˆ·æ–°é‡è¯•');
        });

        // æœªå¤„ç†çš„Promiseé”™è¯¯
        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªå¤„ç†çš„Promiseé”™è¯¯:', event.reason);
            updateStatus('å¼‚æ­¥æ“ä½œå‡ºé”™', true);
            showError('å¼‚æ­¥æ“ä½œå¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
        });
    </script>
</body>
</html>
